<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#5B8A72">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Margie's List">
    <title>Auntie Margie's Daily List</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #5B8A72;
            --primary-light: #7BA894;
            --primary-dark: #3D5E4C;
            --warm-bg: #FFF8F0;
            --warm-cream: #FEF3E2;
            --text-dark: #2D3436;
            --text-medium: #636E72;
            --accent-coral: #E17055;
            --accent-sunny: #FDCB6E;
            --accent-sky: #74B9FF;
            --white: #FFFFFF;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 30px rgba(0,0,0,0.12);
            --radius: 20px;
            --radius-sm: 12px;
            --font-size-base: 18px;
            --font-size-large: 22px;
            --font-size-xlarge: 28px;
            --font-size-huge: 36px;
        }

        .text-size-large {
            --font-size-base: 22px;
            --font-size-large: 26px;
            --font-size-xlarge: 34px;
            --font-size-huge: 44px;
        }

        .text-size-xlarge {
            --font-size-base: 26px;
            --font-size-large: 32px;
            --font-size-xlarge: 40px;
            --font-size-huge: 52px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--warm-bg);
            color: var(--text-dark);
            font-size: var(--font-size-base);
            line-height: 1.5;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--white);
            padding: 25px 20px;
            text-align: center;
            position: relative;
        }

        .settings-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 24px;
            color: var(--white);
            transition: all 0.3s ease;
        }

        .settings-btn:hover, .settings-btn:active {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .greeting {
            font-size: var(--font-size-huge);
            font-weight: 800;
            margin-bottom: 5px;
        }

        .date-display {
            font-size: var(--font-size-large);
            opacity: 0.95;
            font-weight: 600;
        }

        .friendly-message {
            margin-top: 10px;
            font-size: var(--font-size-base);
            opacity: 0.9;
            font-style: italic;
        }

        /* Main Content */
        .main-content {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Card Styles */
        .card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            transition: transform 0.2s ease;
        }

        .card:active {
            transform: scale(0.98);
        }

        .card-title {
            font-size: var(--font-size-large);
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            font-size: 28px;
        }

        /* Next Up Section */
        .next-up-card {
            background: linear-gradient(135deg, var(--accent-sunny) 0%, #F9A825 100%);
            color: var(--text-dark);
        }

        .next-up-card .card-title {
            color: var(--text-dark);
        }

        .next-event {
            font-size: var(--font-size-xlarge);
            font-weight: 700;
            margin-bottom: 10px;
        }

        .next-event-time {
            font-size: var(--font-size-large);
            opacity: 0.9;
        }

        .countdown {
            background: rgba(255,255,255,0.4);
            border-radius: var(--radius-sm);
            padding: 15px;
            margin-top: 15px;
            text-align: center;
            font-size: var(--font-size-large);
            font-weight: 600;
        }

        .no-events {
            font-size: var(--font-size-large);
            text-align: center;
            padding: 20px;
            color: var(--text-medium);
        }

        /* Today's Events */
        .event-list {
            list-style: none;
        }

        .event-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: var(--warm-cream);
            border-radius: var(--radius-sm);
            margin-bottom: 10px;
            border-left: 5px solid var(--primary);
        }

        .event-item:last-child {
            margin-bottom: 0;
        }

        .event-time {
            font-weight: 700;
            color: var(--primary-dark);
            min-width: 80px;
            font-size: var(--font-size-base);
        }

        .event-name {
            flex: 1;
            font-size: var(--font-size-base);
        }

        .event-item.completed {
            opacity: 0.6;
            border-left-color: var(--text-medium);
        }

        .event-item.completed .event-name {
            text-decoration: line-through;
        }

        /* Week Ahead Styles */
        .week-day-group {
            margin-bottom: 20px;
        }

        .week-day-group:last-child {
            margin-bottom: 0;
        }

        .week-day-header {
            font-size: var(--font-size-base);
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary-light);
        }

        .week-event-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: var(--warm-cream);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            border-left: 4px solid var(--accent-sky);
        }

        .week-event-item:last-child {
            margin-bottom: 0;
        }

        .week-event-time {
            font-weight: 600;
            color: var(--primary-dark);
            min-width: 70px;
            font-size: calc(var(--font-size-base) * 0.9);
        }

        .week-event-name {
            flex: 1;
            font-size: calc(var(--font-size-base) * 0.95);
        }

        /* Journal Button */
        .journal-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--accent-coral) 0%, #D63031 100%);
            color: var(--white);
            border: none;
            border-radius: var(--radius);
            padding: 25px;
            font-size: var(--font-size-large);
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            font-family: 'Nunito', sans-serif;
        }

        .journal-btn:hover, .journal-btn:active {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .journal-btn.recording {
            background: linear-gradient(135deg, #D63031 0%, #C0392B 100%);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .mic-icon {
            font-size: 32px;
        }

        /* Journal Choice Modal */
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .choice-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 25px;
            border: 3px solid transparent;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Nunito', sans-serif;
        }

        .choice-btn-type {
            background: linear-gradient(135deg, var(--accent-sky) 0%, #0984E3 100%);
            color: var(--white);
        }

        .choice-btn-type:hover, .choice-btn-type:active {
            transform: scale(1.02);
            box-shadow: var(--shadow-lg);
        }

        .choice-btn-speak {
            background: linear-gradient(135deg, var(--accent-coral) 0%, #D63031 100%);
            color: var(--white);
        }

        .choice-btn-speak:hover, .choice-btn-speak:active {
            transform: scale(1.02);
            box-shadow: var(--shadow-lg);
        }

        .choice-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .choice-label {
            font-size: var(--font-size-large);
            font-weight: 700;
        }

        .choice-desc {
            font-size: var(--font-size-base);
            opacity: 0.9;
            margin-top: 5px;
        }

        .cancel-choice-btn {
            width: 100%;
            padding: 15px;
            background: transparent;
            border: 2px solid var(--text-medium);
            border-radius: var(--radius-sm);
            color: var(--text-medium);
            font-size: var(--font-size-base);
            font-weight: 600;
            cursor: pointer;
            font-family: 'Nunito', sans-serif;
            transition: all 0.2s ease;
        }

        .cancel-choice-btn:hover {
            background: var(--warm-cream);
        }

        /* Text Entry Modal */
        .text-entry-area {
            width: 100%;
            padding: 20px;
            border: 2px solid var(--primary-light);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-base);
            font-family: 'Nunito', sans-serif;
            resize: vertical;
            min-height: 150px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .text-entry-area:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(91, 138, 114, 0.2);
        }

        .text-entry-area::placeholder {
            color: var(--text-medium);
            opacity: 0.7;
        }

        /* Recent Journal Entries */
        .journal-entry {
            background: var(--warm-cream);
            border-radius: var(--radius-sm);
            padding: 15px;
            margin-bottom: 10px;
        }

        .journal-entry:last-child {
            margin-bottom: 0;
        }

        .journal-time {
            font-size: 14px;
            color: var(--text-medium);
            margin-bottom: 8px;
        }

        .journal-text {
            font-size: var(--font-size-base);
            color: var(--text-dark);
        }

        .journal-summary {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--primary-light);
            font-style: italic;
            color: var(--primary-dark);
        }

        /* Settings Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--white);
            border-radius: var(--radius);
            padding: 30px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: var(--font-size-xlarge);
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 25px;
            text-align: center;
        }

        .setting-group {
            margin-bottom: 25px;
        }

        .setting-label {
            font-size: var(--font-size-base);
            font-weight: 600;
            margin-bottom: 15px;
            display: block;
        }

        .setting-options {
            display: flex;
            gap: 10px;
        }

        .setting-btn {
            flex: 1;
            padding: 15px;
            border: 3px solid var(--primary-light);
            background: var(--white);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-base);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Nunito', sans-serif;
            color: var(--text-dark);
        }

        .setting-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: var(--white);
        }

        .setting-btn:hover {
            border-color: var(--primary);
        }

        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .toggle {
            width: 60px;
            height: 34px;
            background: #ccc;
            border-radius: 17px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle.active {
            background: var(--primary);
        }

        .toggle::after {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            background: var(--white);
            border-radius: 50%;
            top: 4px;
            left: 4px;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .toggle.active::after {
            transform: translateX(26px);
        }

        .close-modal-btn {
            width: 100%;
            padding: 18px;
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-large);
            font-weight: 700;
            cursor: pointer;
            margin-top: 10px;
            font-family: 'Nunito', sans-serif;
        }

        /* Recording Modal */
        .recording-modal {
            text-align: center;
        }

        .recording-modal .modal-title {
            margin-bottom: 20px;
        }

        .recording-indicator {
            width: 100px;
            height: 100px;
            background: var(--accent-coral);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 45px;
            animation: pulse 1.5s infinite;
        }

        .recording-text {
            font-size: var(--font-size-large);
            color: var(--text-dark);
            margin-bottom: 20px;
        }

        .transcript-preview {
            background: var(--warm-cream);
            border-radius: var(--radius-sm);
            padding: 20px;
            margin-bottom: 20px;
            min-height: 100px;
            text-align: left;
            font-size: var(--font-size-base);
        }

        .recording-buttons {
            display: flex;
            gap: 15px;
        }

        .recording-buttons button {
            flex: 1;
            padding: 18px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-base);
            font-weight: 700;
            cursor: pointer;
            font-family: 'Nunito', sans-serif;
        }

        .stop-btn {
            background: var(--accent-coral);
            color: var(--white);
        }

        .cancel-btn {
            background: var(--text-medium);
            color: var(--white);
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 30px;
            color: var(--text-medium);
        }

        .empty-state-icon {
            font-size: 50px;
            margin-bottom: 15px;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: var(--text-medium);
            font-size: 14px;
        }

        /* Notification permission banner */
        .notification-banner {
            background: var(--accent-sky);
            color: var(--text-dark);
            padding: 15px 20px;
            text-align: center;
            display: none;
        }

        .notification-banner.show {
            display: block;
        }

        .notification-banner button {
            background: var(--white);
            border: none;
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            font-weight: 700;
            margin-left: 10px;
            cursor: pointer;
            font-family: 'Nunito', sans-serif;
        }

        /* Accessibility - focus states */
        button:focus, .toggle:focus {
            outline: 3px solid var(--accent-sunny);
            outline-offset: 2px;
        }

        /* Loading spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: var(--white);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Notification Permission Banner -->
    <div class="notification-banner" id="notificationBanner">
        <span>Want reminders for your appointments, Margie?</span>
        <button onclick="requestNotificationPermission()">Yes please!</button>
    </div>

    <!-- Header -->
    <header class="header">
        <button class="settings-btn" onclick="openSettings()" aria-label="Settings">‚öôÔ∏è</button>
        <h1 class="greeting" id="greeting">Hello, Margie!</h1>
        <p class="date-display" id="dateDisplay"></p>
        <p class="friendly-message" id="friendlyMessage"></p>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Next Up Card -->
        <div class="card next-up-card" id="nextUpCard">
            <h2 class="card-title">
                <span class="card-icon">‚è∞</span>
                Coming Up Next
            </h2>
            <div id="nextEventContent">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Today's Events Card -->
        <div class="card">
            <h2 class="card-title">
                <span class="card-icon">üìÖ</span>
                What's On Today
            </h2>
            <ul class="event-list" id="eventList">
                <!-- Populated by JS -->
            </ul>
        </div>

        <!-- Week Ahead Card -->
        <div class="card" id="weekAheadCard">
            <h2 class="card-title">
                <span class="card-icon">üìÜ</span>
                This Week Ahead
            </h2>
            <div id="weekAheadList">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Voice Journal Button -->
        <button class="journal-btn" id="journalBtn" onclick="openJournalChoice()">
            <span class="mic-icon">üìù</span>
            <span>Tell me about your day, Margie!</span>
        </button>

        <!-- Recent Journal Entries -->
        <div class="card" id="journalCard">
            <h2 class="card-title">
                <span class="card-icon">üìù</span>
                Your Day So Far
            </h2>
            <div id="journalEntries">
                <!-- Populated by JS -->
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        Made with üíö for Auntie Margie
    </footer>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <h2 class="modal-title">‚öôÔ∏è Settings</h2>
            
            <div class="setting-group">
                <label class="setting-label">Text Size</label>
                <div class="setting-options">
                    <button class="setting-btn active" data-size="normal" onclick="setTextSize('normal')">Normal</button>
                    <button class="setting-btn" data-size="large" onclick="setTextSize('large')">Large</button>
                    <button class="setting-btn" data-size="xlarge" onclick="setTextSize('xlarge')">Extra Large</button>
                </div>
            </div>

            <div class="setting-group">
                <div class="toggle-container">
                    <label class="setting-label" style="margin-bottom: 0;">Audio Reminders</label>
                    <div class="toggle active" id="audioToggle" onclick="toggleAudio()" tabindex="0" role="switch" aria-checked="true"></div>
                </div>
            </div>

            <div class="setting-group">
                <div class="toggle-container">
                    <label class="setting-label" style="margin-bottom: 0;">Morning Summary</label>
                    <div class="toggle active" id="morningToggle" onclick="toggleMorningSummary()" tabindex="0" role="switch" aria-checked="true"></div>
                </div>
            </div>

            <button class="close-modal-btn" onclick="closeSettings()">Done</button>
        </div>
    </div>

    <!-- Journal Choice Modal -->
    <div class="modal-overlay" id="journalChoiceModal">
        <div class="modal">
            <h2 class="modal-title">üìù Tell Me About Your Day</h2>
            <p style="text-align: center; color: var(--text-medium); margin-bottom: 25px;">
                How would you like to add your entry, Margie?
            </p>
            <div class="choice-buttons">
                <button class="choice-btn choice-btn-type" onclick="openTextEntry()">
                    <span class="choice-icon">‚å®Ô∏è</span>
                    <span class="choice-label">Type It</span>
                    <span class="choice-desc">Write what you've been up to</span>
                </button>
                <button class="choice-btn choice-btn-speak" onclick="openVoiceEntry()">
                    <span class="choice-icon">üé§</span>
                    <span class="choice-label">Speak It</span>
                    <span class="choice-desc">Talk and I'll write it down</span>
                </button>
            </div>
            <button class="cancel-choice-btn" onclick="closeJournalChoice()">Maybe Later</button>
        </div>
    </div>

    <!-- Text Entry Modal -->
    <div class="modal-overlay" id="textEntryModal">
        <div class="modal">
            <h2 class="modal-title">‚å®Ô∏è Type Your Entry</h2>
            <p style="text-align: center; color: var(--text-medium); margin-bottom: 20px;">
                What have you been up to today, Margie?
            </p>
            <textarea 
                class="text-entry-area" 
                id="textEntryArea" 
                placeholder="I had a lovely morning..."
                rows="6"
            ></textarea>
            <div class="recording-buttons">
                <button class="cancel-btn" onclick="closeTextEntry()">Cancel</button>
                <button class="stop-btn" onclick="saveTextEntry()">Save Entry</button>
            </div>
        </div>
    </div>

    <!-- Recording Modal -->
    <div class="modal-overlay" id="recordingModal">
        <div class="modal recording-modal">
            <h2 class="modal-title">üé§ Speak Your Entry</h2>
            <div class="recording-indicator" id="recordingIndicator">üé§</div>
            <p class="recording-text" id="recordingText">Listening to you, Margie...</p>
            <div class="transcript-preview" id="transcriptPreview">
                <em>What you say will appear here...</em>
            </div>
            <div class="recording-buttons">
                <button class="cancel-btn" onclick="cancelRecording()">Cancel</button>
                <button class="stop-btn" onclick="stopRecording()">Save Entry</button>
            </div>
        </div>
    </div>

    <script>
        // ===== APP STATE =====
        let state = {
            events: [],
            journalEntries: [],
            settings: {
                textSize: 'normal',
                audioReminders: true,
                morningSummary: true
            }
        };

        // Friendly messages that rotate
        const friendlyMessages = [
            "Hope you're having a lovely day! ‚òÄÔ∏è",
            "Remember, you're doing brilliantly! üåü",
            "Take it one step at a time, Margie! üö∂‚Äç‚ôÄÔ∏è",
            "What adventures await today? üéâ",
            "You've got this! üí™",
            "Time for a cuppa? ‚òï",
            "Sending you a big hug! ü§ó",
            "Every day is a fresh start! üå∏"
        ];

        const timeGreetings = {
            morning: "Good Morning, Margie!",
            afternoon: "Good Afternoon, Margie!",
            evening: "Good Evening, Margie!"
        };

        // ===== INITIALIZATION =====
        function init() {
            loadState();
            updateDateTime();
            renderEvents();
            renderWeekAhead();
            renderJournalEntries();
            applySettings();
            checkNotificationPermission();
            scheduleMorningReminder();
            
            // Update time every minute
            setInterval(updateDateTime, 60000);
            // Update countdown every minute
            setInterval(updateNextEvent, 60000);
        }

        function loadState() {
            // Load settings from main app storage
            const savedSettings = localStorage.getItem('margieListSettings');
            if (savedSettings) {
                state.settings = JSON.parse(savedSettings);
            }
            
            // Load events and journal from shared family storage
            const familyData = localStorage.getItem('margieListSharedData');
            if (familyData) {
                const parsed = JSON.parse(familyData);
                state.events = parsed.events || [];
                state.journalEntries = parsed.journalEntries || [];
            }
        }

        function saveState() {
            // Save settings separately (app-specific)
            localStorage.setItem('margieListSettings', JSON.stringify(state.settings));
            
            // Save events and journal to shared storage (synced with family portal)
            localStorage.setItem('margieListSharedData', JSON.stringify({
                events: state.events,
                journalEntries: state.journalEntries,
                lastUpdated: new Date().toISOString()
            }));
        }

        // ===== DATE & TIME =====
        function updateDateTime() {
            const now = new Date();
            const hour = now.getHours();
            
            // Set greeting based on time
            let greeting;
            if (hour < 12) {
                greeting = timeGreetings.morning;
            } else if (hour < 17) {
                greeting = timeGreetings.afternoon;
            } else {
                greeting = timeGreetings.evening;
            }
            document.getElementById('greeting').textContent = greeting;
            
            // Format date nicely
            const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
            const dateStr = now.toLocaleDateString('en-GB', options);
            document.getElementById('dateDisplay').textContent = dateStr;
            
            // Random friendly message
            const randomMsg = friendlyMessages[Math.floor(Math.random() * friendlyMessages.length)];
            document.getElementById('friendlyMessage').textContent = randomMsg;
            
            updateNextEvent();
        }

        function formatDateForStorage(date) {
            return date.toISOString().split('T')[0];
        }

        function formatTimeForDisplay(time24) {
            const [hours, minutes] = time24.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'pm' : 'am';
            const hour12 = hour % 12 || 12;
            return `${hour12}:${minutes}${ampm}`;
        }

        // ===== EVENTS =====
        function getTodaysEvents() {
            const today = formatDateForStorage(new Date());
            return state.events
                .filter(e => e.date === today)
                .sort((a, b) => a.time.localeCompare(b.time));
        }

        function getNextEvent() {
            const now = new Date();
            const currentTime = now.getHours().toString().padStart(2, '0') + ':' + 
                               now.getMinutes().toString().padStart(2, '0');
            
            const todaysEvents = getTodaysEvents();
            return todaysEvents.find(e => e.time > currentTime && !e.completed);
        }

        function updateNextEvent() {
            const nextEvent = getNextEvent();
            const container = document.getElementById('nextEventContent');
            
            if (nextEvent) {
                const now = new Date();
                const [hours, minutes] = nextEvent.time.split(':');
                const eventTime = new Date(now);
                eventTime.setHours(parseInt(hours), parseInt(minutes), 0);
                
                const diffMs = eventTime - now;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMins / 60);
                const remainingMins = diffMins % 60;
                
                let countdown;
                if (diffHours > 0) {
                    countdown = `${diffHours} hour${diffHours > 1 ? 's' : ''} and ${remainingMins} minute${remainingMins !== 1 ? 's' : ''}`;
                } else {
                    countdown = `${diffMins} minute${diffMins !== 1 ? 's' : ''}`;
                }
                
                container.innerHTML = `
                    <p class="next-event">${nextEvent.title}</p>
                    <p class="next-event-time">at ${formatTimeForDisplay(nextEvent.time)}</p>
                    <div class="countdown">‚è±Ô∏è In ${countdown}</div>
                `;
                
                // Schedule notification 1 hour before
                scheduleEventReminder(nextEvent);
            } else {
                container.innerHTML = `
                    <div class="no-events">
                        <p>Nothing else on today, Margie! üéâ</p>
                        <p style="margin-top: 10px; font-size: 0.9em;">Time to relax!</p>
                    </div>
                `;
            }
        }

        function renderEvents() {
            const events = getTodaysEvents();
            const container = document.getElementById('eventList');
            
            if (events.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p>No events today ‚Äî a quiet day!</p>
                    </div>
                `;
                return;
            }
            
            const now = new Date();
            const currentTime = now.getHours().toString().padStart(2, '0') + ':' + 
                               now.getMinutes().toString().padStart(2, '0');
            
            container.innerHTML = events.map(event => {
                const isPast = event.time < currentTime;
                return `
                    <li class="event-item ${isPast ? 'completed' : ''}" onclick="toggleEventComplete('${event.id}')">
                        <span class="event-time">${formatTimeForDisplay(event.time)}</span>
                        <span class="event-name">${event.title}</span>
                        <span>${isPast ? '‚úì' : '‚óã'}</span>
                    </li>
                `;
            }).join('');
            
            updateNextEvent();
        }

        function toggleEventComplete(id) {
            const event = state.events.find(e => e.id === id);
            if (event) {
                event.completed = !event.completed;
                saveState();
                renderEvents();
            }
        }

        function getWeekAheadEvents() {
            const today = new Date();
            const todayStr = formatDateForStorage(today);
            
            // Get dates for next 7 days (excluding today)
            const weekDates = [];
            for (let i = 1; i <= 7; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() + i);
                weekDates.push(formatDateForStorage(date));
            }
            
            return state.events
                .filter(e => weekDates.includes(e.date))
                .sort((a, b) => {
                    if (a.date !== b.date) return a.date.localeCompare(b.date);
                    return a.time.localeCompare(b.time);
                });
        }

        function renderWeekAhead() {
            const events = getWeekAheadEvents();
            const container = document.getElementById('weekAheadList');
            
            if (events.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üåà</div>
                        <p>Nothing planned for the week ahead yet!</p>
                        <p style="margin-top: 10px; font-size: 0.9em;">Your family can add events for you.</p>
                    </div>
                `;
                return;
            }
            
            // Group events by date
            const groupedEvents = {};
            events.forEach(event => {
                if (!groupedEvents[event.date]) {
                    groupedEvents[event.date] = [];
                }
                groupedEvents[event.date].push(event);
            });
            
            // Build HTML for each day
            let html = '';
            for (const date in groupedEvents) {
                const dateObj = new Date(date + 'T00:00:00');
                const dayName = dateObj.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'short' });
                
                html += `<div class="week-day-group">`;
                html += `<div class="week-day-header">üìå ${dayName}</div>`;
                
                groupedEvents[date].forEach(event => {
                    html += `
                        <div class="week-event-item">
                            <span class="week-event-time">${formatTimeForDisplay(event.time)}</span>
                            <span class="week-event-name">${event.title}</span>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            container.innerHTML = html;
        }

        // ===== JOURNAL ENTRY =====
        let recognition;
        let isRecording = false;
        let transcript = '';

        // Journal Choice Modal
        function openJournalChoice() {
            document.getElementById('journalChoiceModal').classList.add('active');
        }

        function closeJournalChoice() {
            document.getElementById('journalChoiceModal').classList.remove('active');
        }

        // Text Entry
        function openTextEntry() {
            closeJournalChoice();
            document.getElementById('textEntryArea').value = '';
            document.getElementById('textEntryModal').classList.add('active');
            // Focus the text area after a short delay for the modal to appear
            setTimeout(() => {
                document.getElementById('textEntryArea').focus();
            }, 100);
        }

        function closeTextEntry() {
            document.getElementById('textEntryModal').classList.remove('active');
            document.getElementById('textEntryArea').value = '';
        }

        function saveTextEntry() {
            const text = document.getElementById('textEntryArea').value.trim();
            if (text) {
                saveJournalEntry(text);
            }
            closeTextEntry();
        }

        // Voice Entry
        function openVoiceEntry() {
            closeJournalChoice();
            startRecording();
        }

        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-GB';
                
                recognition.onresult = (event) => {
                    transcript = '';
                    for (let i = 0; i < event.results.length; i++) {
                        transcript += event.results[i][0].transcript;
                    }
                    document.getElementById('transcriptPreview').textContent = transcript || 'What you say will appear here...';
                };
                
                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    if (event.error === 'not-allowed') {
                        alert("Margie, I need permission to use the microphone. Please allow it in your browser settings!");
                    }
                };
                
                recognition.onend = () => {
                    if (isRecording) {
                        recognition.start(); // Keep listening
                    }
                };
                
                return true;
            }
            return false;
        }

        function startRecording() {
            if (!initSpeechRecognition()) {
                alert("Sorry Margie, your browser doesn't support voice recording. Try using Safari or Chrome!");
                return;
            }
            
            isRecording = true;
            transcript = '';
            document.getElementById('transcriptPreview').innerHTML = '<em>What you say will appear here...</em>';
            document.getElementById('recordingModal').classList.add('active');
            
            try {
                recognition.start();
            } catch (e) {
                console.error('Error starting recognition:', e);
            }
        }

        function stopRecording() {
            isRecording = false;
            if (recognition) {
                recognition.stop();
            }
            
            if (transcript.trim()) {
                saveJournalEntry(transcript);
            }
            
            document.getElementById('recordingModal').classList.remove('active');
        }

        function cancelRecording() {
            isRecording = false;
            if (recognition) {
                recognition.stop();
            }
            transcript = '';
            document.getElementById('recordingModal').classList.remove('active');
        }

        function saveJournalEntry(text) {
            const entry = {
                id: Date.now().toString(),
                timestamp: new Date().toISOString(),
                text: text,
                summary: null // Will be generated when online
            };
            
            state.journalEntries.unshift(entry);
            saveState();
            renderJournalEntries();
            
            // Try to generate summary
            generateSummary(entry.id, text);
        }

        async function generateSummary(entryId, text) {
            // This would connect to an AI service for summarization
            // For now, we'll create a simple summary
            const words = text.split(' ');
            let summary;
            
            if (words.length < 10) {
                summary = text;
            } else {
                // Simple extractive summary for demo
                summary = "Margie talked about: " + text.substring(0, 100) + (text.length > 100 ? '...' : '');
            }
            
            const entry = state.journalEntries.find(e => e.id === entryId);
            if (entry) {
                entry.summary = summary;
                saveState();
                renderJournalEntries();
            }
        }

        function renderJournalEntries() {
            const container = document.getElementById('journalEntries');
            const today = formatDateForStorage(new Date());
            
            // Filter to today's entries only
            const todaysEntries = state.journalEntries.filter(e => 
                e.timestamp.startsWith(today)
            );
            
            if (todaysEntries.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéôÔ∏è</div>
                        <p>No entries yet today.</p>
                        <p style="margin-top: 10px;">Tap the button above to tell me about your day!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = todaysEntries.map(entry => {
                const time = new Date(entry.timestamp).toLocaleTimeString('en-GB', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                return `
                    <div class="journal-entry">
                        <p class="journal-time">üïê ${time}</p>
                        <p class="journal-text">"${entry.text}"</p>
                        ${entry.summary ? `<p class="journal-summary">üìã ${entry.summary}</p>` : ''}
                    </div>
                `;
            }).join('');
        }

        // ===== SETTINGS =====
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function setTextSize(size) {
            state.settings.textSize = size;
            saveState();
            applySettings();
            
            // Update button states
            document.querySelectorAll('[data-size]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.size === size);
            });
        }

        function toggleAudio() {
            state.settings.audioReminders = !state.settings.audioReminders;
            saveState();
            applySettings();
        }

        function toggleMorningSummary() {
            state.settings.morningSummary = !state.settings.morningSummary;
            saveState();
            applySettings();
        }

        function applySettings() {
            // Text size
            document.body.classList.remove('text-size-large', 'text-size-xlarge');
            if (state.settings.textSize === 'large') {
                document.body.classList.add('text-size-large');
            } else if (state.settings.textSize === 'xlarge') {
                document.body.classList.add('text-size-xlarge');
            }
            
            // Update toggles
            document.getElementById('audioToggle').classList.toggle('active', state.settings.audioReminders);
            document.getElementById('morningToggle').classList.toggle('active', state.settings.morningSummary);
            
            // Update size buttons
            document.querySelectorAll('[data-size]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.size === state.settings.textSize);
            });
        }

        // ===== NOTIFICATIONS =====
        function checkNotificationPermission() {
            if ('Notification' in window) {
                if (Notification.permission === 'default') {
                    document.getElementById('notificationBanner').classList.add('show');
                }
            }
        }

        async function requestNotificationPermission() {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();
                document.getElementById('notificationBanner').classList.remove('show');
                
                if (permission === 'granted') {
                    showNotification('Hello Margie! üëã', "I'll remind you about your appointments now!");
                }
            }
        }

        function showNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: 'icon-192.png',
                    badge: 'icon-192.png',
                    vibrate: [200, 100, 200]
                });
                
                // Also speak it if audio is enabled
                if (state.settings.audioReminders) {
                    speak(body);
                }
            }
        }

        function speak(text) {
            if ('speechSynthesis' in window && state.settings.audioReminders) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9; // Slightly slower for clarity
                utterance.pitch = 1;
                utterance.lang = 'en-GB';
                speechSynthesis.speak(utterance);
            }
        }

        function scheduleEventReminder(event) {
            // This would ideally use a service worker for background notifications
            // For now, we'll check periodically
            const now = new Date();
            const [hours, minutes] = event.time.split(':');
            const eventTime = new Date(now);
            eventTime.setHours(parseInt(hours), parseInt(minutes), 0);
            
            const reminderTime = new Date(eventTime.getTime() - 60 * 60 * 1000); // 1 hour before
            
            if (reminderTime > now) {
                const delay = reminderTime - now;
                setTimeout(() => {
                    showNotification(
                        `Coming up, Margie! ‚è∞`,
                        `${event.title} in about 1 hour at ${formatTimeForDisplay(event.time)}`
                    );
                }, delay);
            }
        }

        function scheduleMorningReminder() {
            // Check if it's morning and we haven't shown today's summary
            const now = new Date();
            const hour = now.getHours();
            const today = formatDateForStorage(now);
            const lastMorning = localStorage.getItem('lastMorningSummary');
            
            if (hour >= 7 && hour < 10 && lastMorning !== today && state.settings.morningSummary) {
                const events = getTodaysEvents();
                if (events.length > 0) {
                    const eventList = events.map(e => e.title).join(', ');
                    showNotification(
                        `Good morning, Margie! ‚òÄÔ∏è`,
                        `Today you have: ${eventList}`
                    );
                    localStorage.setItem('lastMorningSummary', today);
                }
            }
        }

        // ===== DATA SYNC (for Family Portal) =====
        function getShareableData() {
            return {
                events: state.events,
                journalEntries: state.journalEntries,
                lastUpdated: new Date().toISOString()
            };
        }

        function importEvents(newEvents) {
            newEvents.forEach(newEvent => {
                const exists = state.events.find(e => e.id === newEvent.id);
                if (!exists) {
                    state.events.push(newEvent);
                }
            });
            saveState();
            renderEvents();
        }

        // Expose for family portal integration
        window.MimaDay = {
            getShareableData,
            importEvents,
            state
        };

        // ===== START THE APP =====
        document.addEventListener('DOMContentLoaded', init);

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed:', err));
        }
    </script>
</body>
</html>
